============================= test session starts =============================
platform win32 -- Python 3.13.1, pytest-7.4.0, pluggy-1.6.0 -- C:\Users\astir\Desktop\AI_Company\AI_Investor\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\astir\Desktop\AI_Company\AI_Investor
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-0.21.1, base-url-2.1.0
asyncio: mode=Mode.AUTO
collecting ... collected 13 items

tests/api/test_ai_assistant_api.py::test_create_conversation_success FAILED [  7%]
tests/api/test_ai_assistant_api.py::test_create_conversation_missing_user_id FAILED [ 15%]
tests/api/test_ai_assistant_api.py::test_get_conversation_success FAILED [ 23%]
tests/api/test_ai_assistant_api.py::test_send_message_success FAILED     [ 30%]
tests/api/test_ai_assistant_api.py::test_get_recommendations_success FAILED [ 38%]
tests/api/test_ai_predictions_api.py::test_predict_price_success FAILED  [ 46%]
tests/api/test_ai_predictions_api.py::test_predict_price_missing_symbol FAILED [ 53%]
tests/api/test_ai_predictions_api.py::test_predict_trend_success FAILED  [ 61%]
tests/api/test_ai_predictions_api.py::test_get_market_regime_success FAILED [ 69%]
tests/api/test_integration_api.py::test_create_integration_success PASSED [ 76%]
tests/api/test_integration_api.py::test_create_integration_missing_params PASSED [ 84%]
tests/api/test_integration_api.py::test_get_user_integrations_success PASSED [ 92%]
tests/api/test_integration_api.py::test_sync_integration_success FAILED  [100%]

================================== FAILURES ===================================
______________________ test_create_conversation_success _______________________
tests\api\test_ai_assistant_api.py:50: in test_create_conversation_success
    mock_conversation = Conversation(
E   pydantic_core._pydantic_core.ValidationError: 2 validation errors for Conversation
E   created_date
E     Field required [type=missing, input_value={'conversation_id': 'conv...sation', 'messages': []}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   updated_date
E     Field required [type=missing, input_value={'conversation_id': 'conv...sation', 'messages': []}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
__________________ test_create_conversation_missing_user_id ___________________
tests\api\test_ai_assistant_api.py:73: in test_create_conversation_missing_user_id
    response = client.post('/api/ai-assistant/conversation/create', json={})
venv\Lib\site-packages\werkzeug\test.py:1167: in post
    return self.open(*args, **kw)
venv\Lib\site-packages\flask\testing.py:235: in open
    response = super().open(
venv\Lib\site-packages\werkzeug\test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
venv\Lib\site-packages\werkzeug\test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
venv\Lib\site-packages\werkzeug\test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
venv\Lib\site-packages\flask\app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
venv\Lib\site-packages\flask\app.py:1514: in wsgi_app
    response = self.handle_exception(e)
venv\Lib\site-packages\flask\app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
venv\Lib\site-packages\flask\app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
venv\Lib\site-packages\flask\app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
venv\Lib\site-packages\flask\app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
venv\Lib\site-packages\asgiref\sync.py:233: in __call__
    raise RuntimeError(
E   RuntimeError: You cannot use AsyncToSync in the same thread as an async event loop - just await the async function directly.
________________________ test_get_conversation_success ________________________
tests\api\test_ai_assistant_api.py:85: in test_get_conversation_success
    mock_conversation = Conversation(
E   pydantic_core._pydantic_core.ValidationError: 2 validation errors for Conversation
E   created_date
E     Field required [type=missing, input_value={'conversation_id': 'conv...sation', 'messages': []}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   updated_date
E     Field required [type=missing, input_value={'conversation_id': 'conv...sation', 'messages': []}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
__________________________ test_send_message_success __________________________
tests\api\test_ai_assistant_api.py:105: in test_send_message_success
    mock_message = ConversationMessage(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for ConversationMessage
E   timestamp
E     Field required [type=missing, input_value={'message_id': 'msg_1', '...ontent': 'Test message'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
______________________ test_get_recommendations_success _______________________
tests\api\test_ai_assistant_api.py:130: in test_get_recommendations_success
    Recommendation(
E   pydantic_core._pydantic_core.ValidationError: 6 validation errors for Recommendation
E   recommendation_type
E     Field required [type=missing, input_value={'recommendation_id': 're...lancing your portfolio'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   title
E     Field required [type=missing, input_value={'recommendation_id': 're...lancing your portfolio'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   description
E     Field required [type=missing, input_value={'recommendation_id': 're...lancing your portfolio'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   confidence
E     Field required [type=missing, input_value={'recommendation_id': 're...lancing your portfolio'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   reasoning
E     Field required [type=missing, input_value={'recommendation_id': 're...lancing your portfolio'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   created_date
E     Field required [type=missing, input_value={'recommendation_id': 're...lancing your portfolio'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
_________________________ test_predict_price_success __________________________
tests\api\test_ai_predictions_api.py:50: in test_predict_price_success
    mock_prediction = PricePrediction(
E   pydantic_core._pydantic_core.ValidationError: 3 validation errors for PricePrediction
E   prediction_id
E     Field required [type=missing, input_value={'symbol': 'AAPL', 'predi...5, 'time_horizon': '1m'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   prediction_date
E     Field required [type=missing, input_value={'symbol': 'AAPL', 'predi...5, 'time_horizon': '1m'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   model_version
E     Field required [type=missing, input_value={'symbol': 'AAPL', 'predi...5, 'time_horizon': '1m'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
______________________ test_predict_price_missing_symbol ______________________
tests\api\test_ai_predictions_api.py:75: in test_predict_price_missing_symbol
    response = client.post('/api/ai-predictions/price', json={})
venv\Lib\site-packages\werkzeug\test.py:1167: in post
    return self.open(*args, **kw)
venv\Lib\site-packages\flask\testing.py:235: in open
    response = super().open(
venv\Lib\site-packages\werkzeug\test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
venv\Lib\site-packages\werkzeug\test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
venv\Lib\site-packages\werkzeug\test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
venv\Lib\site-packages\flask\app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
venv\Lib\site-packages\flask\app.py:1514: in wsgi_app
    response = self.handle_exception(e)
venv\Lib\site-packages\flask\app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
venv\Lib\site-packages\flask\app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
venv\Lib\site-packages\flask\app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
venv\Lib\site-packages\flask\app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
venv\Lib\site-packages\asgiref\sync.py:233: in __call__
    raise RuntimeError(
E   RuntimeError: You cannot use AsyncToSync in the same thread as an async event loop - just await the async function directly.
_________________________ test_predict_trend_success __________________________
tests\api\test_ai_predictions_api.py:87: in test_predict_trend_success
    mock_trend = TrendPrediction(
E   pydantic_core._pydantic_core.ValidationError: 3 validation errors for TrendPrediction
E   prediction_id
E     Field required [type=missing, input_value={'symbol': 'AAPL', 'trend...5, 'time_horizon': '1m'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   trend_strength
E     Field required [type=missing, input_value={'symbol': 'AAPL', 'trend...5, 'time_horizon': '1m'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   predicted_change
E     Field required [type=missing, input_value={'symbol': 'AAPL', 'trend...5, 'time_horizon': '1m'}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
_______________________ test_get_market_regime_success ________________________
tests\api\test_ai_predictions_api.py:108: in test_get_market_regime_success
    mock_regime = MarketRegime(
E   pydantic_core._pydantic_core.ValidationError: 2 validation errors for MarketRegime
E   regime_id
E     Field required [type=missing, input_value={'regime_type': 'bull', '...: 0.8, 'indicators': {}}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
E   detected_date
E     Field required [type=missing, input_value={'regime_type': 'bull', '...: 0.8, 'indicators': {}}, input_type=dict]
E       For further information visit https://errors.pydantic.dev/2.12/v/missing
________________________ test_sync_integration_success ________________________
tests\api\test_integration_api.py:111: in test_sync_integration_success
    assert response.status_code == 200
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
------------------------------ Captured log call ------------------------------
ERROR    web.api.integration_api:integration_api.py:112 Error syncing integration: 415 Unsupported Media Type: Did not attempt to load JSON data because the request Content-Type was not 'application/json'.
============================== warnings summary ===============================
tests/api/test_integration_api.py::test_create_integration_success
  C:\Users\astir\Desktop\AI_Company\AI_Investor\web\api\integration_api.py:60: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    'data': integration.dict()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/api/test_ai_assistant_api.py::test_create_conversation_success
FAILED tests/api/test_ai_assistant_api.py::test_create_conversation_missing_user_id
FAILED tests/api/test_ai_assistant_api.py::test_get_conversation_success - py...
FAILED tests/api/test_ai_assistant_api.py::test_send_message_success - pydant...
FAILED tests/api/test_ai_assistant_api.py::test_get_recommendations_success
FAILED tests/api/test_ai_predictions_api.py::test_predict_price_success - pyd...
FAILED tests/api/test_ai_predictions_api.py::test_predict_price_missing_symbol
FAILED tests/api/test_ai_predictions_api.py::test_predict_trend_success - pyd...
FAILED tests/api/test_ai_predictions_api.py::test_get_market_regime_success
FAILED tests/api/test_integration_api.py::test_sync_integration_success - ass...
=================== 10 failed, 3 passed, 1 warning in 1.84s ===================
