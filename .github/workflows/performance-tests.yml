name: Performance Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  # ---------------------------------------------------------------------------
  # Load Testing
  # ---------------------------------------------------------------------------
  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up k6
        uses: grafana/k6-action@v0.3.0
        with:
          k6-version: latest
      
      - name: Run load tests
        run: |
          k6 run tests/load/load_test_scenarios.js
        env:
          API_URL: ${{ secrets.TEST_BASE_URL || 'http://localhost:5050' }}
          TEST_EMAIL: ${{ secrets.LOAD_TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.LOAD_TEST_PASSWORD }}
      
      - name: Upload load test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: k6-load-test-results
          path: test-results/
          retention-days: 30
      
      - name: Run performance benchmarks
        run: |
          k6 run tests/load/performance_benchmarks.js
        env:
          API_URL: ${{ secrets.TEST_BASE_URL || 'http://localhost:5050' }}
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: k6-benchmark-results
          path: test-results/
          retention-days: 30

  # ---------------------------------------------------------------------------
  # API Performance Benchmarks
  # ---------------------------------------------------------------------------
  api-benchmarks:
    name: API Performance Benchmarks
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install locust pytest-benchmark
      
      - name: Start backend server
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test_secret
          SECRET_KEY: test_secret
        run: |
          gunicorn web.wsgi:application --bind 0.0.0.0:5050 --workers 2 &
          sleep 5
      
      - name: Run API benchmarks
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        run: |
          pytest tests/performance/benchmarks.py --benchmark-json=benchmark-results.json
      
      - name: Compare benchmarks
        uses: rhysd/github-action-benchmark@v1
        with:
          tool: 'pytest'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          alert-threshold: '200%'
          fail-on-alert: true
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: benchmark-results
          path: benchmark-results.json

  # ---------------------------------------------------------------------------
  # Frontend Performance
  # ---------------------------------------------------------------------------
  frontend-performance:
    name: Frontend Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend2/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend2
        run: npm ci --legacy-peer-deps
      
      - name: Build for production
        working-directory: frontend2
        env:
          VITE_BACKEND_URL: http://localhost:5050
        run: npm run build
      
      - name: Analyze bundle size
        working-directory: frontend2
        run: |
          npm install -g bundlesize
          bundlesize
      
      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
