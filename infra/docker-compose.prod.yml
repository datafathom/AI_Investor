# Production Infrastructure: docker-compose.prod.yml

version: '3.8'
name: ai-investor-prod

services:
  # ---------------------------------------------------------------------------
  # Database Layer (TimescaleDB)
  # ---------------------------------------------------------------------------
  postgres-prod:
    image: timescale/timescaledb:latest-pg15
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 4GB
          cpus: '2.0'
    networks:
      - prod-network

  # ---------------------------------------------------------------------------
  # Cache & Session Layer (Redis)
  # ---------------------------------------------------------------------------
  redis-prod:
    image: redis:7-alpine
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    deploy:
      resources:
        limits:
          memory: 1GB
    networks:
      - prod-network

  # ---------------------------------------------------------------------------
  # Message Bus (Kafka)
  # ---------------------------------------------------------------------------
  kafka-prod:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      - zookeeper-prod
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-prod:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-prod:9092
      KAFKA_HEAP_OPTS: "-Xmx1G -Xms1G"
    deploy:
      resources:
        limits:
          memory: 2GB
    networks:
      - prod-network

  zookeeper-prod:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks:
      - prod-network

  # ---------------------------------------------------------------------------
  # Graph Engine (Neo4j)
  # ---------------------------------------------------------------------------
  neo4j-prod:
    image: neo4j:5.12.0
    restart: always
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
      NEO4J_dbms_memory_heap_max__size: 2G
    deploy:
      resources:
        limits:
          memory: 4GB
    networks:
      - prod-network

  # ---------------------------------------------------------------------------
  # Edge Gateway (Nginx) - SSL Termination
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
    networks:
      - prod-network

networks:
  prod-network:
    driver: bridge
