# CDN and Static Asset Optimization for NGINX
# Location: /etc/nginx/conf.d/cdn.conf or similar

# 1. Compression Settings
# Enable Gzip compression
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

# Brotli compression (requires ngx_brotli module)
# brotli on;
# brotli_comp_level 6;
# brotli_types text/plain text/css application/javascript application/json image/svg+xml;

# 2. Caching Policies
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;

    # Hashed Assets (Long-term Cache)
    # Vite includes hashes in filenames (e.g., index-B7x2.js), so we can cache forever.
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable, max-age=31536000";
        access_log off;
    }

    # Static Config/JSON (Short-term Cache)
    location ~* \.(?:json|xml)$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate, max-age=3600";
    }

    # HTML (No Cache - always fetch to ensure latest JS version is used)
    location / {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        try_files $uri $uri/ /index.html;
    }

    # Security Headers (CDN Best Practice)
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}
