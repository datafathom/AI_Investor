# Implementation Plan - [x] Cycle M: Trading & Strategy Stabilization
- [ ] Cycle N: Advanced Portfolio & Risk Analytics

---

## Cycle N: Advanced Portfolio & Risk Analytics

### [Analytics & Attribution API]
#### [MODIFY] [test_analytics_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_analytics_api.py)
- Correct model imports: `PerformanceAttribution` -> [AttributionResult](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/analytics.py#77-90), [ConcentrationRisk](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/analytics.py#133-140) -> [ConcentrationRiskAnalysis](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/analytics.py#133-140).
- Update Pydantic mocks to match V2 fields in `models.analytics`.
- Remove `async` from tests and resolve `AsyncToSync` runtime errors.
#### [MODIFY] [test_attribution_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_attribution_api.py)
- Correct import: [AttributionResult](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/analytics.py#77-90) from `services.analysis.attribution_service` -> [BrinsonAttribution](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/services/analysis/attribution_service.py#70-83).
- Remove `async` from tests.

### [Advanced Risk API]
#### [MODIFY] [test_advanced_risk_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_advanced_risk_api.py)
- Update [RiskMetrics](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/risk.py#32-48) and [StressTestResult](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/risk.py#59-69) Pydantic mocks to match V2 fields.
- Remove `async` from tests.

### [Portfolio Optimization API]
#### [MODIFY] [test_optimization_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_optimization_api.py)
- Update `OptimizationResult`, `RebalancingRecommendation`, and `RebalancingHistory` Pydantic mocks.
- Fix missing `datetime` import.
- Remove `async` from tests.
- Populate `PortfolioExecuteResult` mock correctly.

### [Core Models]
#### [MODIFY] [analytics.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/analytics.py)
- Ensure all models have necessary fields (mostly already there, just need to update tests to match).

## Proposed Changes

### 1. Paper Trading API
#### [MODIFY] [test_paper_trading_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_paper_trading_api.py)
- Update imports from `models.trading` to `models.paper_trading`.
- Remove `@pytest.mark.asyncio` and `async` keywords from synchronous test functions.
- (Wait, checking if they are actually async in the API first).

### 2. Strategy API
#### [MODIFY] [test_strategy_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_strategy_api.py)
- Change import `from models.strategy import Strategy` to `from models.strategy import TradingStrategy`.
- Update [test_start_strategy_success](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_strategy_api.py#110-130) and [test_get_strategy_performance_success](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_strategy_api.py#151-174) to include all required Pydantic fields.
- Remove incorrect `async` markers.

### 3. Backtest & Margin APIs
#### [MODIFY] [test_backtest_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_backtest_api.py)
#### [MODIFY] [test_margin_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_margin_api.py)
- Replace `response.get_json()` with `response.json()` as these tests use FastAPI's `TestClient`.

### 4. Options API
#### [MODIFY] [test_options_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_options_api.py)
- Update `PnLAnalysis` import to [StrategyPnL](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/options.py#82-91).
- Populate missing fields in [OptionsStrategy](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/options.py#48-60) and [StrategyAnalysis](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/options.py#93-100) mocks.
- Fix async/sync markers.

### 5. Scenario API
#### [MODIFY] [test_scenario_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_scenario_api.py)
- Update [ScenarioResult](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/services/analysis/scenario_service.py#21-29) mock instantiation to include `scenario_id` and `positions_affected`.
- Replace `response.get_json()` with `response.json()`.

## Verification Plan

### Automated Tests
Run the Cycle M test suite:
```powershell
python -m pytest tests/api/test_paper_trading_api.py tests/api/test_strategy_api.py tests/api/test_backtest_api.py tests/api/test_options_api.py tests/api/test_margin_api.py tests/api/test_scenario_api.py -vv
```
Target: 100% Pass Rate.
