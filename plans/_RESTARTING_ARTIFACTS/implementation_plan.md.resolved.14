# Implementation Plan - Cycle M: Trading & Strategy Stabilization

Stabilize the Trading and Strategy-related APIs to achieve 100% test coverage and compliance with Pydantic V2 and FastAPI standards.

## Proposed Changes

### 1. Paper Trading API
#### [MODIFY] [test_paper_trading_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_paper_trading_api.py)
- Update imports from `models.trading` to `models.paper_trading`.
- Remove `@pytest.mark.asyncio` and `async` keywords from synchronous test functions.
- (Wait, checking if they are actually async in the API first).

### 2. Strategy API
#### [MODIFY] [test_strategy_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_strategy_api.py)
- Change import `from models.strategy import Strategy` to `from models.strategy import TradingStrategy`.
- Update `test_start_strategy_success` and `test_get_strategy_performance_success` to include all required Pydantic fields.
- Remove incorrect `async` markers.

### 3. Backtest & Margin APIs
#### [MODIFY] [test_backtest_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_backtest_api.py)
#### [MODIFY] [test_margin_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_margin_api.py)
- Replace `response.get_json()` with `response.json()` as these tests use FastAPI's `TestClient`.

### 4. Options API
#### [MODIFY] [test_options_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_options_api.py)
- Update `PnLAnalysis` import to [StrategyPnL](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/options.py#82-91).
- Populate missing fields in [OptionsStrategy](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/options.py#48-60) and [StrategyAnalysis](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/models/options.py#93-100) mocks.
- Fix async/sync markers.

### 5. Scenario API
#### [MODIFY] [test_scenario_api.py](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/tests/api/test_scenario_api.py)
- Update [ScenarioResult](file:///c:/Users/astir/Desktop/AI_Company/AI_Investor/services/analysis/scenario_service.py#21-29) mock instantiation to include `scenario_id` and `positions_affected`.
- Replace `response.get_json()` with `response.json()`.

## Verification Plan

### Automated Tests
Run the Cycle M test suite:
```powershell
python -m pytest tests/api/test_paper_trading_api.py tests/api/test_strategy_api.py tests/api/test_backtest_api.py tests/api/test_options_api.py tests/api/test_margin_api.py tests/api/test_scenario_api.py -vv
```
Target: 100% Pass Rate.
